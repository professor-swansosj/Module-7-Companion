# 05: Jinja2 Templates - Dynamic Configuration Generation

## ğŸ¯ Mission

Master Jinja2 templating to create dynamic, data-driven network configurations. You'll build reusable templates that generate custom configurations based on your host and group variables, making your automation scalable and maintainable.

## ğŸ– Goals

- [ ] Understand Jinja2 template syntax and structure
- [ ] Create templates for common Cisco configuration sections
- [ ] Use variables, loops, and conditionals in templates
- [ ] Generate configuration files from templates and variables
- [ ] Build templates for interfaces, VLANs, and basic device settings

## ğŸ“š Why This Matters

Templates are the secret sauce of network automation. Instead of writing separate configurations for each device, you create one template that adapts based on variables. Change a VLAN across 50 switches? Update one variable. Add a new interface type? Modify one template. Templates turn your variables into actual device configurations.

## ğŸ”‘ Key Terms

- **Jinja2**: Templating engine that generates text files from templates and variables
- **Template**: A file with placeholders that get filled in with actual values
- **Variable Substitution**: Replacing `{{ variable_name }}` with actual values
- **Loops**: Repeating template sections for lists of data (like interfaces or VLANs)
- **Conditionals**: Including configuration only when certain conditions are met
- **Filters**: Functions that modify variables (like `| upper` or `| default`)

## ğŸ›  Jinja2 Syntax Basics

**Variable substitution:**

```jinja2
hostname {{ hostname }}
ip domain-name {{ domain_name }}
```

**Loops for repeated configuration:**

```jinja2
{% for vlan in vlans %}
vlan {{ vlan.id }}
 name {{ vlan.name }}
{% endfor %}
```

**Conditionals for optional settings:**

```jinja2
{% if enable_cdp %}
cdp run
{% endif %}
```

**Comments (not included in output):**

```jinja2
{# This is a comment explaining the template section #}
```

## ğŸ“„ Template Examples

**templates/base_config.j2** - Basic device configuration:

```jinja2
!
! Generated by Ansible on {{ ansible_date_time.date }}
! Device: {{ inventory_hostname }}
!
hostname {{ hostname }}
!
ip domain-name {{ domain_name }}
!
{# Configure NTP servers from group variables #}
{% for ntp_server in ntp_servers %}
ntp server {{ ntp_server }}
{% endfor %}
!
{# Configure interfaces if they exist #}
{% if interfaces is defined %}
{% for interface in interfaces %}
interface {{ interface.name }}
 description {{ interface.description | default('Configured by Ansible') }}
 {% if interface.ip is defined %}
 ip address {{ interface.ip }} {{ interface.mask }}
 {% endif %}
 no shutdown
{% endfor %}
{% endif %}
!
end
```

**templates/vlan_config.j2** - VLAN configuration for switches:

```jinja2
!
! VLAN Configuration for {{ inventory_hostname }}
!
{% for vlan in vlans %}
vlan {{ vlan.id }}
 name {{ vlan.name | upper }}
{% endfor %}
!
{# Configure VLAN interfaces if defined #}
{% if vlan_interfaces is defined %}
{% for vlan_int in vlan_interfaces %}
interface vlan{{ vlan_int.vlan_id }}
 description {{ vlan_int.description }}
 ip address {{ vlan_int.ip }} {{ vlan_int.mask }}
 no shutdown
{% endfor %}
{% endif %}
!
```

## ğŸ’¡ Try It: Create Your First Templates

1. **Create templates directory**:

   ```bash
   mkdir templates
   ```

2. **Build a basic configuration template**:
   - TODO: Create `templates/base_config.j2` using the example above
   - Include hostname, domain, and NTP configuration
   - Add interface configuration section

3. **Test template rendering**:

   ```bash
   # Test template with debug module
   ansible-playbook -i inventory/hosts.yml test_template.yml
   ```

4. **Create specialized templates**:
   - TODO: Create `templates/vlan_config.j2` for switch VLANs
   - TODO: Create `templates/interface_config.j2` for interface-specific settings

## ğŸ® Template Rendering Playbook

Create a playbook that generates configurations using templates:

```yaml
---
- name: Generate Device Configurations
  hosts: all
  gather_facts: yes  # Need facts for ansible_date_time
  
  tasks:
    - name: Generate base configuration
      template:
        src: base_config.j2
        dest: "./configs/{{ inventory_hostname }}_config.txt"
      # TODO: This creates individual config files for each device
      
    - name: Display generated configuration
      debug:
        msg: "Configuration generated for {{ inventory_hostname }}"

- name: Generate VLAN configurations for switches
  hosts: switches
  gather_facts: no
  
  tasks:
    - name: Generate VLAN configuration
      template:
        src: vlan_config.j2  
        dest: "./configs/{{ inventory_hostname }}_vlans.txt"
      # TODO: Creates VLAN configs only for switches
      
    - name: Show VLAN configuration content
      debug:
        var: lookup('file', './configs/' + inventory_hostname + '_vlans.txt')
```

## ğŸ”§ Advanced Template Features

**Using filters to modify variables:**

```jinja2
{# Convert to uppercase #}
hostname {{ hostname | upper }}

{# Provide default values #}  
description {{ interface.description | default('No description') }}

{# Format IP addresses #}
ip address {{ mgmt_ip | ipaddr('address') }} {{ mgmt_ip | ipaddr('netmask') }}
```

**Nested loops and complex logic:**

```jinja2
{% for device_group in groups %}
! Group: {{ device_group }}
{% for host in groups[device_group] %}
 ! Device: {{ host }}
{% endfor %}
{% endfor %}
```

## ğŸ” Check Yourself

1. What's the difference between `{{ variable }}` and `{% for loop %}` in Jinja2?
2. How would you include a configuration section only for routers?
3. What filter would you use to provide a default value for an undefined variable?
4. How do you add comments in templates that don't appear in the output?
5. What happens if you reference a variable that doesn't exist in your template?

## ğŸ›  Template Best Practices

**Organize templates logically:**

```bash
templates/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ global_config.j2
â”‚   â””â”€â”€ security_config.j2  
â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ ethernet_config.j2
â”‚   â””â”€â”€ loopback_config.j2
â””â”€â”€ routing/
    â”œâ”€â”€ ospf_config.j2
    â””â”€â”€ static_routes.j2
```

**Use descriptive comments:**

```jinja2
{# 
  Interface Configuration Template
  Generates interface configurations based on host_vars
  Requires: interfaces list with name, ip, mask, description
#}
```

## ğŸ”— Essential Resources

- [Jinja2 Template Designer Documentation](https://jinja.palletsprojects.com/en/3.0.x/templates/)
- [Ansible Template Module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html)
- [Ansible Templating Guide](https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html)

## ğŸš€ Next Up

You've mastered the fundamentals! In the final topic, you'll combine everything - variables, templates, and playbooks - to build a complete configuration management system!

---

**ğŸ’¡ Pro Tip**: Start with simple templates and add complexity gradually. Test templates with a few devices before rolling out to your entire network!
